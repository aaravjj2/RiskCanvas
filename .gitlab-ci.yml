stages:
  - lint
  - test
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  NODE_OPTIONS: "--max_old_space_size=4096"

# ---------- Lint ----------

lint:python:
  stage: lint
  image: python:3.11-slim
  cache:
    paths: [.pip-cache]
  script:
    - pip install -r apps/api/requirements.txt
    - pip install ruff
    - ruff check apps/api/ packages/engine/

lint:typescript:
  stage: lint
  image: node:20-alpine
  cache:
    paths: [node_modules/]
  script:
    - npm ci
    - npx tsc -p apps/web/tsconfig.json --noEmit

# ---------- Test ----------

test:pytest:
  stage: test
  image: python:3.11-slim
  cache:
    paths: [.pip-cache]
  script:
    - pip install -r apps/api/requirements.txt
    - cd apps/api && python -m pytest -q --tb=short
  artifacts:
    when: always
    reports:
      junit: apps/api/test-results.xml

test:playwright:
  stage: test
  image: mcr.microsoft.com/playwright:v1.58.2-noble
  # v4.5.0: uiunit project (harness) runs before main suite â€” all headed MCP
  cache:
    paths: [node_modules/]
  script:
    - npm ci
    - npx playwright test --config=e2e/playwright.config.ts
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/

test:engine:
  stage: test
  image: python:3.11-slim
  script:
    - cd packages/engine && python -m pytest tests/ -v

# ---------- Build ----------

build:api:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker build -f deploy/digitalocean/Dockerfile.api -t riskcanvas-api:$CI_COMMIT_SHORT_SHA .
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

build:web:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker build -f deploy/digitalocean/Dockerfile.web -t riskcanvas-web:$CI_COMMIT_SHORT_SHA .
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ---------- Deploy ----------

deploy:staging:
  stage: deploy
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "Deploy to staging (placeholder)"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: staging
